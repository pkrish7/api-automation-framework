# API Automation Framework

## Overview
This project is a sample API automation framework using Java, TestNG, Cucumber (BDD), RestAssured, WireMock, SLF4J (with Lombok), and OpenCSV. It demonstrates data-driven testing, externalized configuration, and BDD-style test design for CRUD operations on the `/employees` endpoint.

## Prerequisites
- Java 17+
- Maven 3.6+
- Git

## Setup

1. **Clone the repository**
   ```sh
   git clone https://github.com/pkrish7/api-automation-framework.git
   cd api-automation-framework
   ```

2. **Install dependencies**
   ```sh
   mvn clean install
   ```

3. **Project structure**
   - `src/test/java/stepdefs/EmployeeStepDefs.java`: Step definitions for Cucumber scenarios.
   - `src/test/java/config/TestConfig.java`: Loads config from `src/test/resources/config.properties`.
   - `src/test/java/utils/CsvUtils.java`: Utility for reading CSV test data.
   - `src/test/resources/config.properties`: Externalized configuration (e.g., base URL).
   - `src/test/resources/testdata/employees.csv`: Sample test data for data-driven tests.
   - `src/test/java/features/`: Cucumber feature files.
   - `src/test/java/mocks/WireMockServerSetup.java`: WireMock stubs for API endpoints.

## Configuration

Edit `src/test/resources/config.properties` to change the base URL or other settings:
```
base.url=http://localhost:9090
```

## Running Tests

1. **Run all tests with Maven (parallel, using testng.xml)**
   ```sh
   mvn test -DsuiteXmlFile=testng.xml
   ```

2. **Run tests by category**
   - Smoke tests:
     ```sh
     mvn test -Dcucumber.options="--tags @smoke"
     ```
   - Regression tests:
     ```sh
     mvn test -Dcucumber.options="--tags @regression"
     ```
   - Negative tests:
     ```sh
     mvn test -Dcucumber.options="--tags @negative"
     ```

3. **Run specific TestNG/Cucumber runner**
   ```sh
   mvn test -Dcucumber.options="--tags @positive"
   ```

4. **View reports**
   - Cucumber HTML report: `target/cucumber-report.html`

## Data-Driven Testing

- Employee data for the READ scenario is in `src/test/resources/testdata/employees.csv`.
- You can add more CSV files for other scenarios as needed.

## Logging

- SLF4J (with Lombok @Slf4j) is used for logging.
- Logs are printed to the console during test execution.

## Customization

- Add new feature files in `src/test/java/features/`.
- Add new step definitions in `src/test/java/stepdefs/`.
- Update WireMock stubs in `src/test/java/mocks/WireMockServerSetup.java` for new endpoints or data.

## Troubleshooting

- If you see errors about missing CSV or config files, ensure they are in `src/test/resources` (or subfolders) and Maven copies them to the classpath.
- For port conflicts, change `base.url` in `config.properties` and update WireMock port in `WireMockServerSetup.java`.

## Parallel Execution

- TestNG is configured for parallel execution with 4 threads in `testng.xml`.
- Cucumber step definitions are thread-safe by design (new instance per scenario).

## Running with Docker

You can build and run your tests in a containerized environment using Docker:

- **Build the Docker image:**
  ```sh
  docker build -t api-automation-tests .
  ```
- **Run the tests in a container:**
  ```sh
  docker run --rm -v $(pwd)/target:/app/target api-automation-tests
  ```
- The test reports will be available in your local `target/` directory after the run.

## Environment-Specific Test Data

- Test data is organized by environment:
  - `src/test/resources/testdata/dev/employees.csv`
  - `src/test/resources/testdata/qa/employees.csv`
- The environment is set in `src/test/resources/config.properties` via the `env` property (e.g., `env=dev`).
- You can override the environment at runtime:
  ```sh
  mvn test -Denv=qa
  ```
- Step definitions automatically load the correct test data for the selected environment.

## Retrying Failed Scenarios (Cucumber Rerun)

This framework supports rerunning only failed Cucumber scenarios using the Cucumber rerun plugin and a dedicated runner class. This helps reduce false negatives due to intermittent issues (e.g., network glitches, timing problems).

### How it works
1. **First run:** Execute all scenarios using the main runner (`CucumberTest`). Any failed scenarios will be listed in `target/rerun.txt`. This file is automatically generated by the rerun plugin specified in the runner's `@CucumberOptions`.
2. **Rerun failed scenarios:** Execute only the failed scenarios using the rerun runner (`CucumberRerunTest`). This runner is configured to read from `target/rerun.txt` and will only execute the scenarios listed there.
3. **Fix and verify:** After fixing the failed scenarios, rerun the rerun runner. If all scenarios pass, `target/rerun.txt` will be empty and no tests will be executed by the rerun runner.

### Example Workflow
1. Run all scenarios:
   ```sh
   mvn test -Dtest=runner.CucumberTest
   ```
2. If there are failures, rerun only failed scenarios:
   ```sh
   mvn test -Dtest=runner.CucumberRerunTest
   ```
3. Fix any failed scenarios and repeat step 2 until all pass.

- `CucumberTest` runs all scenarios in the project.
- `CucumberRerunTest` runs only the scenarios listed in `target/rerun.txt` (i.e., failed scenarios from the previous run).

**Note:** The runner class names in your project should be `CucumberTest.java` (main runner) and `CucumberRerunTest.java` (rerun runner). Update them if needed to match this documentation.

## CI/CD with Jenkins

This project includes a Jenkinsfile intended to automate builds, test execution, and report archiving.

> **Note:** Jenkins pipeline execution was partially tested; some plugin issues prevented full validation on my local setup. The Jenkinsfile and Docker setup are included for easy integration.

- Clone the repository
- Build the Docker image
- Use Docker Compose to start both the WireMock server and the test container
- Archive and publish test reports, including the Cucumber HTML report (requires the HTML Publisher plugin)

### Jenkins Setup
1. Create a new Pipeline job in Jenkins.
2. Set the pipeline definition to "Pipeline script from SCM" and provide your repo URL: `https://github.com/pkrish7/api-automation-framework`
3. Install the "HTML Publisher" plugin in Jenkins for HTML report publishing.
4. Trigger the job. Jenkins will use the Jenkinsfile to build, test, and archive reports.

## Known Issues / Notes

- The Jenkinsfile is included in the repo and is configured for CI/CD with Docker and report archiving.
- Due to plugin compatibility issues and environment setup on my local machine, I was unable to fully validate the Jenkins pipeline execution.
- All other aspects of the framework, including Docker-based test runs, work as expected.
- Please feel free to reach out if you want assistance troubleshooting or running Jenkins on your environment.

### Docker Compose in CI
- The pipeline uses `docker-compose up --abort-on-container-exit --build` to start both the WireMock server and the test container.
- Test reports are available in the Jenkins build artifacts and as a direct link to the Cucumber HTML report.

## IDE Setup

For the best development experience, install the following plugins in your IDE (e.g., IntelliJ IDEA, Eclipse):
- **Gherkin**: For syntax highlighting and editing `.feature` files.
- **Cucumber for Java**: For step definition navigation and running Cucumber tests.
- **Lombok**: To support Lombok annotations (e.g., `@Slf4j`). Make sure annotation processing is enabled in your IDE settings.

## Getting Started

1. **Clone the repository** and install dependencies as described above.
2. **Import the project** into your IDE as a Maven project.
3. **Ensure required plugins are installed** (see IDE Setup above).
4. **Build the project** with `mvn clean install` to download dependencies and compile sources.
5. **Run tests** using the provided Maven commands or from your IDE using the runner classes (`CucumberTest` and `CucumberRerunTest`).
6. **View reports** in the `target/` directory after test execution.
